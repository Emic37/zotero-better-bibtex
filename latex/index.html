<html>
  <head>
    <title>BibTeX Translator</title>
    <script>
      var Translator = { unicode: true, debug: function(msg) { console.log(msg); }}, LaTeX = {};
    </script>
    <script src="franc-most.js"></script>
    <script src="xregexp-all.js"></script>
    <script src="titlecaser.js"></script>
    <script src="_titlecaser.js"></script>
    <script src="markupparser.js"></script>
    <script src="latex_unicode_mapping.js"></script>
    <script src="unicode_translator.js"></script>

    <script>

      var TitleCaser = {
        citeproc: Translator.TitleCaser.titleCase.bind(Translator.TitleCaser),
        simple: Translator.simpleTitleCaser.titleCase.bind(Translator.simpleTitleCaser)
      };

      function parse() {
        var language;
        var lang;
        var titles = document.getElementById('titles').value;
        var translator;
        var tc;

        if (document.getElementById("simple").checked) {
          Translator.TitleCaser.titleCase = TitleCaser.simple;
          tc = 'simple';
        } else {
          Translator.TitleCaser.titleCase = TitleCaser.citeproc;
          tc = 'citeproc';
        }

        if (document.getElementById("eng").checked) {
          language = 'eng'
        } 
        else if (document.getElementById("und").checked) {
          language = 'und'
        }

        if (document.getElementById("bibtex").checked) {
          translator = 'bibtex';
          Translator.BetterBibTeX = true;
          Translator.BetterBibLaTeX = false;
        } else {
          translator = 'biblatex';
          Translator.BetterBibTeX = false;
          Translator.BetterBibLaTeX = true;
        }

        if (window.location.protocol != 'file:') {
          window.history.pushState(null, null, 'index.html?tc=' + tc + '&translator=' + translator + '&titles=' + encodeURIComponent(titles) + '&language=' + (language || 'guess'));
        }

        var output = document.getElementById('output');
        var bibtex;
        output.textContent = '';

        titles.split("\n").forEach(function(title) {
          if (!title.trim()) { return; }

          lang = language || franc(title) || 'und';
          bibtex = '{' + LaTeX.text2latex(title, {caseConversion: Translator.BetterBibLaTeX && (lang == 'eng' || lang == 'sco')}) + '}';
          if (Translator.BetterBibTeX && (lang != 'eng' && lang != 'sco')) { bibtex = '{' + bibtex + '}'; }

          output.textContent += lang + ': ' + title + "\n" + translator + ': ' + bibtex + "\n\n";
        });
        return false;
      }
    </script>
  </head>
  <body>
    <form onsubmit="return parse();">
      <textarea id="titles" rows="10" cols="120">
      </textarea>
      <br/>
      Language:
        <input id="eng" type="radio" name="language" value="eng"> Assume English&nbsp;&nbsp;
        <input id="und" type="radio" name="language" value="und"> Assume Other&nbsp;&nbsp;
        <input id="guess" type="radio" name="language" value="guess"> Guess<br/>
      
      Mode: <input id="bibtex" type="radio" name="translator" value="bibtex"> BibTeX&nbsp;&nbsp;<input id="biblatex" type="radio" name="translator" value="biblatex"> BibLaTeX<br>
      Title Caser: <input id="citeproc" type="radio" name="tc" value="citeproc"> Citeproc&nbsp;&nbsp;<input id="simple" type="radio" name="tc" value="simple"> Simple<br>
      <input type="submit" vaue="Translate">
    </form>
    <pre id="output"></pre>
  </body>

  <script>
    function decode(str) {
      if (!str) { return str; }
      return decodeURIComponent(str.replace(/\+/g, ' '));
    }

    var QueryString = function () {
      // This function is anonymous, is executed immediately and 
      // the return value is assigned to QueryString!
      var query_string = {};
      var query = window.location.search.substring(1);
      var vars = query.split("&");
      for (var i=0;i<vars.length;i++) {
        var pair = vars[i].split("=");
            // If first entry with this name
        if (typeof query_string[pair[0]] === "undefined") {
          query_string[pair[0]] = decode(pair[1]);
            // If second entry with this name
        } else if (typeof query_string[pair[0]] === "string") {
          var arr = [ query_string[pair[0]],decode(pair[1]) ];
          query_string[pair[0]] = arr;
            // If third or later entry with this name
        } else {
          query_string[pair[0]].push(decode(pair[1]));
        }
      } 
        return query_string;
    }();

    document.getElementById('titles').value = QueryString.titles || '';

    var language = {eng: 'eng', und: 'und'}[QueryString.language] || 'guess';
    document.getElementById('eng').checked = (language == 'eng');
    document.getElementById('und').checked = (language == 'und');
    document.getElementById('guess').checked = (language == 'guess');

    var translator = {bibtex: 'bibtex'}[QueryString.translator] || 'biblatex';
    document.getElementById('bibtex').checked = (translator == 'bibtex');
    document.getElementById('biblatex').checked = (translator == 'biblatex');

    var tc = {simple: 'simple'}[QueryString.tc] || 'citeproc';
    document.getElementById('simple').checked = (tc == 'simple');
    document.getElementById('citeproc').checked = (tc == 'citeproc');

    if (QueryString.titles) { parse(); }
  </script>
</html>
